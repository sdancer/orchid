#!/usr/bin/env bash
# Orchid server manager
# Usage: ./orchid start|stop|restart|status|log

set -e
cd "$(dirname "$0")"

PIDFILE="priv/data/orchid.pid"
LOGFILE="priv/data/server.log"
ENV_FILE=".env"

if [ -f "$ENV_FILE" ]; then
  source "$ENV_FILE"
fi

log_lifecycle() {
  local msg="$1"
  local ts
  ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  echo "[$ts] orchidctl: $msg" >> "$LOGFILE"
}

get_pid() {
  if [ -f "$PIDFILE" ]; then
    local pid=$(cat "$PIDFILE")
    if kill -0 "$pid" 2>/dev/null; then
      echo "$pid"
      return 0
    fi
    rm -f "$PIDFILE"
  fi
  # Fallback: find by process name
  pgrep -f "orchid@127.0.0.1.*mix phx.server" 2>/dev/null | head -1
}

do_start() {
  local pid=$(get_pid)
  if [ -n "$pid" ]; then
    echo "Orchid already running (PID $pid)"
    return 1
  fi

  echo "Starting Orchid..."
  mkdir -p priv/data

  # Raise soft open-file limit for the server process (up to hard limit).
  # Some shells default to soft=1024 even when hard is much higher.
  local hard_nofile
  hard_nofile=$(ulimit -Hn 2>/dev/null || echo "")
  if [ -n "$hard_nofile" ]; then
    ulimit -n "$hard_nofile" 2>/dev/null || true
  fi

  elixir --name orchid@127.0.0.1 -S mix phx.server >> "$LOGFILE" 2>&1 &
  local pid=$!

  # Verify process survives initial boot before reporting success
  local healthy=1
  for i in $(seq 1 5); do
    if ! kill -0 "$pid" 2>/dev/null; then
      healthy=0
      break
    fi
    sleep 1
  done

  if [ "$healthy" -eq 1 ]; then
    echo "$pid" > "$PIDFILE"
    echo "Orchid started (PID $pid)"
    echo "Log: $LOGFILE"
    log_lifecycle "started pid=$pid"
  else
    rm -f "$PIDFILE"
    echo "Orchid failed to start"
    log_lifecycle "failed_to_start pid=$pid"
    echo "Recent log output:"
    tail -n 20 "$LOGFILE" 2>/dev/null || true
    return 1
  fi
}

do_stop() {
  local pid=$(get_pid)
  if [ -z "$pid" ]; then
    echo "Orchid not running"
    return 0
  fi

  echo "Stopping Orchid (PID $pid)..."
  kill "$pid" 2>/dev/null || true

  # Wait for graceful shutdown
  for i in $(seq 1 10); do
    if ! kill -0 "$pid" 2>/dev/null; then
      rm -f "$PIDFILE"
      echo "Orchid stopped"
      log_lifecycle "stopped pid=$pid graceful=true"
      return 0
    fi
    sleep 1
  done

  echo "Force killing..."
  kill -9 "$pid" 2>/dev/null || true
  rm -f "$PIDFILE"
  echo "Orchid killed"
  log_lifecycle "stopped pid=$pid graceful=false"
}

do_status() {
  local pid=$(get_pid)
  if [ -n "$pid" ]; then
    echo "Orchid running (PID $pid)"
    # Show uptime
    ps -o etime= -p "$pid" 2>/dev/null | xargs echo "Uptime:"
  else
    echo "Orchid not running"
  fi
}

do_log() {
  tail -f "$LOGFILE"
}

do_reset() {
  local cookie
  cookie=$(cat "$HOME/.erlang.cookie" 2>/dev/null || echo "orchid")
  elixir --name "reset-$$@127.0.0.1" --cookie "$cookie" priv/scripts/reset_project.exs
}

do_inspect() {
  local cookie
  cookie=$(cat "$HOME/.erlang.cookie" 2>/dev/null || echo "orchid")
  elixir --name "inspect-$$@127.0.0.1" --cookie "$cookie" priv/scripts/inspect_agent.exs "$@"
}

do_shell() {
  local project_id="$1"
  if [ -z "$project_id" ]; then
    # List available containers
    echo "Running sandbox containers:"
    podman ps --filter "name=orchid-project-" --format "  {{.Names}} ({{.Status}})"
    echo ""
    echo "Usage: ./orchid shell <project_id>"
    echo "  e.g.: ./orchid shell Pyj_kPs17gjSP9qv"
    return 1
  fi
  local container="orchid-project-${project_id}"
  if ! podman inspect "$container" >/dev/null 2>&1; then
    echo "Container $container not found"
    return 1
  fi
  echo "Entering shell in $container (/workspace)..."
  podman exec -it -w /workspace "$container" bash
}

do_exec() {
  local project_id="$1"
  shift
  if [ -z "$project_id" ] || [ $# -eq 0 ]; then
    echo "Usage: ./orchid exec <project_id> <command...>"
    return 1
  fi
  local container="orchid-project-${project_id}"
  podman exec -w /workspace "$container" sh -c "$*"
}

case "${1:-}" in
  start)   do_start ;;
  stop)    do_stop ;;
  restart) do_stop; sleep 1; : > "$LOGFILE"; do_start ;;
  reset)   do_reset ;;
  status)  do_status ;;
  log)     do_log ;;
  inspect) shift; do_inspect "$@" ;;
  shell)   shift; do_shell "$@" ;;
  exec)    shift; do_exec "$@" ;;
  *)
    echo "Usage: ./orchid {start|stop|restart|reset|inspect|shell|exec|status|log}"
    exit 1
    ;;
esac
